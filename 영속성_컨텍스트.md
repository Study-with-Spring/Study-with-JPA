## 영속성컨텍스트

JPA에서 Entity는 데이터베이스 테이블에 대응하는 하나의 클래스를 의미합니다. 그리고 Entity를 관리하는 것이 EntityManager입니다.<br>
EntityManeger는 내부에 Entity를 영구적으로 저장하는 환경을 두고 관리하는데 이를 영속성 컨텍스트(persistence context)라고 합니다.

### 영속성 컨텍스트의 장점

1. 1차 캐시

   영속성 컨텍스트는 내부에 1차 캐시를 가지고 있습니다. 1차 캐시는 Entity를 저장하는 공간입니다. 1차 캐시는 Entity의 기본키를 키로 사용하여 Entity를 저장합니다. 그리고 1차 캐시는 트랜잭션 단위로 생성되기 때문에 트랜잭션이 종료되면 1차 캐시도 함께 종료됩니다.

2. 동일성 보장

   1차 캐시는 Entity의 기본키를 키로 사용하기 때문에 같은 Entity를 조회하면 1차 캐시에서 조회한 Entity를 반환합니다. 그리고 1차 캐시는 트랜잭션 단위로 생성되기 때문에 트랜잭션이 종료되면 1차 캐시도 함께 종료됩니다. 따라서 같은 Entity를 조회하더라도 트랜잭션이 종료되면 1차 캐시가 종료되기 때문에 다시 조회하면 다른 Entity를 반환합니다.

3. 트랜잭션을 지원하는 쓰기 지연

   영속성 컨텍스트는 트랜잭션을 지원하는 쓰기 지연을 지원합니다. 쓰기 지연은 트랜잭션을 커밋할 때까지 INSERT SQL을 모아서 한번에 전송합니다. 이렇게 하면 네트워크 트래픽을 줄일 수 있습니다.

4. 변경 감지

   영속성 컨텍스트는 변경 감지를 지원합니다. 변경 감지는 트랜잭션을 커밋할 때 영속성 컨텍스트에 저장된 Entity와 스냅샷을 비교하여 변경된 Entity를 찾아서 UPDATE SQL을 전송합니다.

5. 지연 로딩

   영속성 컨텍스트는 지연 로딩을 지원합니다. 지연 로딩은 연관된 Entity를 실제 사용할 때 조회합니다. 따라서 연관된 Entity를 사용하지 않으면 조회하지 않습니다.

**EntityManeger의 주요 메서드**

| 명령어                 | 설명                                                                                                                                                             |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| find(class이름,기본키) | 영속성 컨텍스트에 이미 객체가 있다면 객체를 그대로 반환합니다. <br> 해당 엔티티를 반환하지 않더라도 해당하는 객체를 영속성 컨텍스트로 가져옵니다.                |
| persist(object)        | 객체를 영속화 합니다. 영속성 컨텍스트에 객체를 저장합니다.                                                                                                       |
| remove(object)         | 영속성 컨텍스트에서 객체를 제거합니다.                                                                                                                           |
| createQuery(jpql)      | jpql을 sql로 쿼리를 생성해 데이터베이스에 전송합니다.                                                                                                            |
| detach(object)         | 영속상태의 객체를 비영속상태로 만듭니다.                                                                                                                         |
| clear                  | 영속성 컨텍스트를 초기화하고 해당 영속성 컨텍스트의 엔티티들을 준영속(영속상태의 엔티티가 영속성 컨텍스트에서 분리 된 상태)로 만듭니다.                          |
| flush                  | 영속성 컨텍스트의 변경내용을 DB에 반영합니다.                                                                                                                    |
| close                  | 영속성 컨텍스트를 더이상 관리하지 않습니다. <br>Transaction 수행 후에는 반드시 EntityManager 를 닫아야합니다. <br>그래야 내부적으로 DB Connection 을 반환합니다. |

### EntityManegerFactory

EntityManegerFactory는 EntityManager를 생성하는 공장입니다. EntityManegerFactory는 하나만 생성하고 애플리케이션 전체에서 공유합니다. 그리고 EntityManegerFactory는 애플리케이션 시작 시점에 생성합니다.

EntityMengerFactory는 여러 스레드가 동시에 접근해도 안전하므로 서로 다른 스레드 간에 공유를 해도 됩니다. <br>
EntityManeger는 여러 스레드가 동시에 접근하면 동시성 문제가 발생하므로 스레드 간에 공유는 절대 안되고 데이터베이스 연결이 필요한 시점까지 커넥션을 얻지 않습니다.
